<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Unsubscribe Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: '#eff6ff',
                100: '#dbeafe',
                200: '#bfdbfe',
                300: '#93c5fd',
                400: '#60a5fa',
                500: '#3b82f6',
                600: '#2563eb',
                700: '#1d4ed8',
                800: '#1e40af',
                900: '#1e3a8a',
              },
            },
            boxShadow: {
              'material': '0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24)',
              'material-lg': '0 3px 6px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.12)',
              'material-xl': '0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.10)',
            },
          },
        },
      }
    </script>
    <style>
      [v-cloak] { display: none; }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div id="app" v-cloak>
      <!-- Navigation -->
      <nav class="bg-primary-600 text-white shadow-material">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <div class="flex items-center">
              <span class="text-xl font-semibold">ðŸ“§ Email Unsubscribe</span>
            </div>
            <div class="flex space-x-4">
              <button 
                v-for="tab in tabs" 
                :key="tab.id"
                @click="currentTab = tab.id"
                :class="[
                  'px-3 py-2 rounded-md text-sm font-medium transition-colors',
                  currentTab === tab.id ? 'bg-primary-700' : 'hover:bg-primary-500'
                ]"
              >
                {{ tab.label }}
              </button>
            </div>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Dashboard Tab -->
        <div v-if="currentTab === 'dashboard'">
          <!-- Stats Cards -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-material p-6">
              <div class="text-sm font-medium text-gray-500">Total Processed</div>
              <div class="text-3xl font-bold text-gray-900">{{ stats.total }}</div>
            </div>
            <div class="bg-white rounded-lg shadow-material p-6">
              <div class="text-sm font-medium text-gray-500">Successful</div>
              <div class="text-3xl font-bold text-green-600">{{ stats.success }}</div>
            </div>
            <div class="bg-white rounded-lg shadow-material p-6">
              <div class="text-sm font-medium text-gray-500">Failed</div>
              <div class="text-3xl font-bold text-red-600">{{ stats.failed }}</div>
            </div>
            <div class="bg-white rounded-lg shadow-material p-6">
              <div class="text-sm font-medium text-gray-500">Success Rate</div>
              <div class="text-3xl font-bold text-primary-600">{{ stats.successRate.toFixed(1) }}%</div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="bg-white rounded-lg shadow-material p-6">
            <h2 class="text-lg font-semibold mb-4">Recent Activity</h2>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sender</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Method</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <tr v-for="item in recentActivity" :key="item.id" class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900">{{ item.sender }}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">{{ item.method }}</td>
                    <td class="px-4 py-3">
                      <span :class="statusClass(item.status)">{{ item.status }}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">{{ formatTime(item.attemptedAt) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Failed Tab -->
        <div v-if="currentTab === 'failed'">
          <div class="bg-white rounded-lg shadow-material p-6">
            <h2 class="text-lg font-semibold mb-4">Failed Unsubscribes</h2>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sender</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reason</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Retries</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <tr v-for="item in failedAttempts" :key="item.id" class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900">{{ item.sender }}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">{{ item.failureReason || 'Unknown' }}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">{{ item.retryCount }}</td>
                    <td class="px-4 py-3 text-sm">
                      <button @click="viewDetails(item)" class="text-primary-600 hover:text-primary-800 mr-2">View</button>
                      <button @click="retryUnsubscribe(item.id)" class="text-yellow-600 hover:text-yellow-800 mr-2">Retry</button>
                      <button @click="markResolved(item.id)" class="text-green-600 hover:text-green-800">Resolve</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Allow List Tab -->
        <div v-if="currentTab === 'allowlist'">
          <div class="bg-white rounded-lg shadow-material p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-semibold">Allow List</h2>
              <button @click="showAddModal = true" class="bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700">
                Add Entry
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Value</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <tr v-for="item in allowList" :key="item.id" class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900">{{ item.type }}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 font-mono">{{ item.value }}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">{{ item.notes || '-' }}</td>
                    <td class="px-4 py-3 text-sm">
                      <button @click="removeFromAllowList(item.id)" class="text-red-600 hover:text-red-800">Remove</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Domains Tab -->
        <div v-if="currentTab === 'domains'">
          <div class="bg-white rounded-lg shadow-material p-6">
            <h2 class="text-lg font-semibold mb-4">Domain Statistics</h2>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Domain</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Success</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Failed</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <tr v-for="item in domainStats" :key="item.domain" class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900 font-mono">{{ item.domain }}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">{{ item.total }}</td>
                    <td class="px-4 py-3 text-sm text-green-600">{{ item.success }}</td>
                    <td class="px-4 py-3 text-sm text-red-600">{{ item.failed }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Patterns Tab -->
        <div v-if="currentTab === 'patterns'">
          <div class="bg-white rounded-lg shadow-material p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-semibold">Patterns</h2>
              <div class="space-x-2">
                <button @click="exportPatterns" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
                  Export
                </button>
                <label class="bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 cursor-pointer">
                  Import
                  <input type="file" @change="importPatterns" accept=".json" class="hidden">
                </label>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Selector</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Match Count</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <tr v-for="item in patterns" :key="item.id" class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900">{{ item.name }}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">{{ item.type }}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 font-mono truncate max-w-xs">{{ item.selector }}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">{{ item.matchCount }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>

      <!-- Add Allow List Modal -->
      <div v-if="showAddModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-material-xl p-6 w-96">
          <h3 class="text-lg font-semibold mb-4">Add to Allow List</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
              <select v-model="newEntry.type" class="w-full border rounded-md px-3 py-2">
                <option value="email">Email</option>
                <option value="domain">Domain</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Value</label>
              <input v-model="newEntry.value" type="text" class="w-full border rounded-md px-3 py-2" 
                     :placeholder="newEntry.type === 'email' ? 'user@example.com' : 'example.com'">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
              <input v-model="newEntry.notes" type="text" class="w-full border rounded-md px-3 py-2">
            </div>
            <div class="flex justify-end space-x-2">
              <button @click="showAddModal = false" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
              <button @click="addToAllowList" class="bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700">Add</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Detail Modal -->
      <div v-if="selectedItem" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-material-xl p-6 w-2/3 max-h-[80vh] overflow-y-auto">
          <h3 class="text-lg font-semibold mb-4">Unsubscribe Details</h3>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div><span class="font-medium">Sender:</span> {{ selectedItem.sender }}</div>
            <div><span class="font-medium">Domain:</span> {{ selectedItem.senderDomain }}</div>
            <div><span class="font-medium">Method:</span> {{ selectedItem.method }}</div>
            <div><span class="font-medium">Status:</span> <span :class="statusClass(selectedItem.status)">{{ selectedItem.status }}</span></div>
            <div><span class="font-medium">Failure Reason:</span> {{ selectedItem.failureReason || 'N/A' }}</div>
            <div><span class="font-medium">Retries:</span> {{ selectedItem.retryCount }}</div>
          </div>
          <div v-if="selectedItem.failureDetails" class="mb-4">
            <span class="font-medium">Details:</span>
            <pre class="bg-gray-100 p-2 rounded mt-1 text-sm">{{ selectedItem.failureDetails }}</pre>
          </div>
          <div v-if="selectedItem.screenshotPath" class="mb-4">
            <span class="font-medium">Screenshot:</span>
            <div class="mt-2 border rounded">
              <img :src="'/screenshots/' + selectedItem.id + '.png'" alt="Screenshot" class="max-w-full">
            </div>
          </div>
          <div class="flex justify-end space-x-2">
            <a v-if="selectedItem.tracePath" :href="'/api/failed/' + selectedItem.id + '/trace'" 
               class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
              Download Trace
            </a>
            <button @click="selectedItem = null" class="px-4 py-2 text-gray-600 hover:text-gray-800">Close</button>
          </div>
        </div>
      </div>

      <!-- Toast Notifications -->
      <div class="fixed bottom-4 right-4 space-y-2">
        <div v-for="toast in toasts" :key="toast.id" 
             :class="['px-4 py-2 rounded-md shadow-material text-white', toast.type === 'success' ? 'bg-green-600' : 'bg-red-600']">
          {{ toast.message }}
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, onMounted, computed } = Vue;

      createApp({
        setup() {
          const currentTab = ref('dashboard');
          const tabs = [
            { id: 'dashboard', label: 'Dashboard' },
            { id: 'failed', label: 'Failed' },
            { id: 'allowlist', label: 'Allow List' },
            { id: 'domains', label: 'Domains' },
            { id: 'patterns', label: 'Patterns' },
          ];

          const stats = ref({ total: 0, success: 0, failed: 0, uncertain: 0, pending: 0, successRate: 0 });
          const recentActivity = ref([]);
          const failedAttempts = ref([]);
          const allowList = ref([]);
          const domainStats = ref([]);
          const patterns = ref([]);
          const selectedItem = ref(null);
          const showAddModal = ref(false);
          const newEntry = ref({ type: 'email', value: '', notes: '' });
          const toasts = ref([]);

          const showToast = (message, type = 'success') => {
            const id = Date.now();
            toasts.value.push({ id, message, type });
            setTimeout(() => {
              toasts.value = toasts.value.filter(t => t.id !== id);
            }, 3000);
          };

          const fetchStats = async () => {
            try {
              const res = await fetch('/api/stats');
              stats.value = await res.json();
            } catch (e) {
              console.error('Failed to fetch stats:', e);
            }
          };

          const fetchRecent = async () => {
            try {
              const res = await fetch('/api/recent');
              recentActivity.value = await res.json();
            } catch (e) {
              console.error('Failed to fetch recent:', e);
            }
          };

          const fetchFailed = async () => {
            try {
              const res = await fetch('/api/failed');
              failedAttempts.value = await res.json();
            } catch (e) {
              console.error('Failed to fetch failed:', e);
            }
          };

          const fetchAllowList = async () => {
            try {
              const res = await fetch('/api/allowlist');
              allowList.value = await res.json();
            } catch (e) {
              console.error('Failed to fetch allow list:', e);
            }
          };

          const fetchDomains = async () => {
            try {
              const res = await fetch('/api/domains');
              domainStats.value = await res.json();
            } catch (e) {
              console.error('Failed to fetch domains:', e);
            }
          };

          const fetchPatterns = async () => {
            try {
              const res = await fetch('/api/patterns');
              patterns.value = await res.json();
            } catch (e) {
              console.error('Failed to fetch patterns:', e);
            }
          };

          const statusClass = (status) => {
            const classes = {
              success: 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-800',
              failed: 'px-2 py-1 text-xs rounded-full bg-red-100 text-red-800',
              uncertain: 'px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800',
              pending: 'px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800',
            };
            return classes[status] || classes.pending;
          };

          const formatTime = (dateStr) => {
            return new Date(dateStr).toLocaleString();
          };

          const viewDetails = (item) => {
            selectedItem.value = item;
          };

          const retryUnsubscribe = async (id) => {
            try {
              await fetch(`/api/failed/${id}/retry`, { method: 'POST' });
              showToast('Retry scheduled');
              await fetchFailed();
            } catch (e) {
              showToast('Failed to schedule retry', 'error');
            }
          };

          const markResolved = async (id) => {
            try {
              await fetch(`/api/failed/${id}/resolve`, { method: 'POST' });
              showToast('Marked as resolved');
              await fetchFailed();
              await fetchStats();
            } catch (e) {
              showToast('Failed to mark resolved', 'error');
            }
          };

          const addToAllowList = async () => {
            try {
              await fetch('/api/allowlist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newEntry.value),
              });
              showToast('Added to allow list');
              showAddModal.value = false;
              newEntry.value = { type: 'email', value: '', notes: '' };
              await fetchAllowList();
            } catch (e) {
              showToast('Failed to add entry', 'error');
            }
          };

          const removeFromAllowList = async (id) => {
            try {
              await fetch(`/api/allowlist/${id}`, { method: 'DELETE' });
              showToast('Removed from allow list');
              await fetchAllowList();
            } catch (e) {
              showToast('Failed to remove entry', 'error');
            }
          };

          const exportPatterns = () => {
            window.location.href = '/api/patterns/export';
          };

          const importPatterns = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                const data = JSON.parse(e.target.result);
                const res = await fetch('/api/patterns/import', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data),
                });
                const result = await res.json();
                showToast(`Imported ${result.imported} patterns`);
                await fetchPatterns();
              } catch (e) {
                showToast('Failed to import patterns', 'error');
              }
            };
            reader.readAsText(file);
          };

          onMounted(() => {
            fetchStats();
            fetchRecent();
            fetchFailed();
            fetchAllowList();
            fetchDomains();
            fetchPatterns();
          });

          return {
            currentTab, tabs, stats, recentActivity, failedAttempts,
            allowList, domainStats, patterns, selectedItem, showAddModal,
            newEntry, toasts, statusClass, formatTime, viewDetails,
            retryUnsubscribe, markResolved, addToAllowList, removeFromAllowList,
            exportPatterns, importPatterns
          };
        }
      }).mount('#app');
    </script>
  </body>
</html>
