<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Unsubscribe Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="/output.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div id="app" v-cloak>
      <!-- Navigation -->
      <nav class="bg-primary-600 text-white shadow-material overflow-x-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16 min-w-max">
            <div class="flex items-center flex-shrink-0">
              <span class="text-xl font-semibold">Email Unsubscribe</span>
            </div>
            <div class="flex items-center space-x-4 flex-shrink-0">
              <div class="flex space-x-4">
                <button
                  v-for="tab in tabs"
                  :key="tab.id"
                  @click="currentTab = tab.id"
                  :class="[
                    'px-3 py-2 rounded-md text-sm font-medium transition-colors',
                    currentTab === tab.id ? 'bg-primary-700' : 'hover:bg-primary-500'
                  ]"
                >
                  {{ tab.label }}
                </button>
              </div>
              <!-- Gmail Connection Status -->
              <div
                class="border-l border-primary-400 pl-4 flex items-center space-x-2"
              >
                <template v-if="gmailStatus.authorized">
                  <span class="text-sm"
                  >{{ gmailStatus.connectedEmail || 'Gmail Connected' }}</span>
                  <button
                    @click="disconnectGmail"
                    class="px-2 py-1 text-xs rounded bg-primary-700 hover:bg-primary-800 transition-colors"
                  >
                    Disconnect
                  </button>
                </template>
                <template v-else>
                  <button
                    @click="connectGmail"
                    class="px-3 py-1 text-sm rounded bg-white text-primary-600 hover:bg-gray-100 transition-colors font-medium"
                  >
                    Connect Gmail
                  </button>
                </template>
              </div>
            </div>
          </div>
        </div>
      </nav>

      <!-- Gmail Not Connected Banner -->
      <div
        v-if="!gmailStatus.authorized"
        class="bg-yellow-50 border-l-4 border-yellow-400 p-4"
      >
        <div class="max-w-7xl mx-auto flex items-center">
          <div class="flex-shrink-0">
            <svg
              class="h-5 w-5 text-yellow-400"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                clip-rule="evenodd"
              />
            </svg>
          </div>
          <div class="ml-3 flex-1">
            <p class="text-sm text-yellow-700">
              Connect your Gmail account to start scanning for unsubscribe
              opportunities.
            </p>
          </div>
          <div class="ml-4">
            <button
              @click="connectGmail"
              class="px-4 py-2 bg-yellow-400 text-yellow-900 rounded hover:bg-yellow-500 transition-colors font-medium text-sm"
            >
              Connect Gmail
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Dashboard Tab -->
        <div v-if="currentTab === 'dashboard'">
          <!-- Scan Button -->
          <div class="mb-6 flex justify-end">
            <button
              @click="triggerScan"
              :disabled="scanInProgress || !gmailStatus.authorized"
              :class="[
                'px-4 py-2 rounded-md text-sm font-medium transition-colors',
                (scanInProgress || !gmailStatus.authorized)
                  ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  : 'bg-primary-600 text-white hover:bg-primary-700'
              ]"
              :title="!gmailStatus.authorized ? 'Connect Gmail first' : ''"
            >
              <span v-if="scanInProgress">Scanning...</span>
              <span v-else>Scan Now</span>
            </button>
          </div>

          <!-- Stats Cards -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-material p-6">
              <div class="text-sm font-medium text-gray-500">
                Total Processed
              </div>
              <div class="text-3xl font-bold text-gray-900">
                {{ stats.total }}
              </div>
            </div>
            <div class="bg-white rounded-lg shadow-material p-6">
              <div class="text-sm font-medium text-gray-500">Successful</div>
              <div class="text-3xl font-bold text-green-600">
                {{ stats.success }}
              </div>
            </div>
            <div class="bg-white rounded-lg shadow-material p-6">
              <div class="text-sm font-medium text-gray-500">Failed</div>
              <div class="text-3xl font-bold text-red-600">
                {{ stats.failed }}
              </div>
            </div>
            <div class="bg-white rounded-lg shadow-material p-6">
              <div class="text-sm font-medium text-gray-500">Success Rate</div>
              <div class="text-3xl font-bold text-primary-600">
                {{ stats.successRate.toFixed(1) }}%
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="bg-white rounded-lg shadow-material p-6">
            <h2 class="text-lg font-semibold mb-4">Recent Activity</h2>
            <div v-if="recentActivity.length === 0" class="text-center py-12">
              <svg
                class="w-16 h-16 mx-auto mb-4 text-primary-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
                />
              </svg>
              <p class="text-gray-500">No unsubscribe activity yet</p>
              <p class="text-gray-400 text-sm mt-1">
                Activity will appear here once emails are processed
              </p>
            </div>
            <div v-else class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Sender
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Method
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Status
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Time
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <tr
                    v-for="item in recentActivity"
                    :key="item.id"
                    class="hover:bg-gray-50"
                  >
                    <td class="px-4 py-3 text-sm text-gray-900">
                      {{ item.sender }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                      {{ item.method }}
                    </td>
                    <td class="px-4 py-3">
                      <span :class="statusClass(item.status)"
                      >{{ item.status }}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                      {{ formatTime(item.attemptedAt) }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Failed Tab -->
        <div v-if="currentTab === 'failed'">
          <div class="bg-white rounded-lg shadow-material p-6">
            <h2 class="text-lg font-semibold mb-4">Failed Unsubscribes</h2>
            <div v-if="failedAttempts.length === 0" class="text-center py-12">
              <svg
                class="w-16 h-16 mx-auto mb-4 text-primary-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <p class="text-gray-500">No failed unsubscribes</p>
              <p class="text-gray-400 text-sm mt-1">
                Failed attempts will appear here for review
              </p>
            </div>
            <div v-else class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Sender
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Reason
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Retries
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <tr
                    v-for="item in failedAttempts"
                    :key="item.id"
                    class="hover:bg-gray-50"
                  >
                    <td class="px-4 py-3 text-sm text-gray-900">
                      {{ item.sender }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                      {{ item.failureReason || 'Unknown' }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                      {{ item.retryCount }}
                    </td>
                    <td class="px-4 py-3 text-sm">
                      <div class="flex space-x-2">
                        <button
                          @click="viewDetails(item)"
                          class="bg-primary-100 text-primary-700 px-3 py-1 rounded text-xs font-medium hover:bg-primary-200"
                        >
                          View
                        </button>
                        <button
                          @click="retryUnsubscribe(item.id)"
                          class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded text-xs font-medium hover:bg-yellow-200"
                        >
                          Retry
                        </button>
                        <button
                          @click="markResolved(item.id)"
                          class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-medium hover:bg-green-200"
                        >
                          Resolve
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Allow List Tab -->
        <div v-if="currentTab === 'allowlist'">
          <div class="bg-white rounded-lg shadow-material p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-semibold">Allow List</h2>
              <button
                @click="showAddModal = true"
                class="bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700"
              >
                Add Entry
              </button>
            </div>
            <div v-if="allowList.length === 0" class="text-center py-12">
              <svg
                class="w-16 h-16 mx-auto mb-4 text-primary-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
                />
              </svg>
              <p class="text-gray-500">No allowed senders yet</p>
              <p class="text-gray-400 text-sm mt-1">
                Add emails or domains you want to keep receiving
              </p>
            </div>
            <div v-else class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Type
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Value
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Notes
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <tr
                    v-for="item in allowList"
                    :key="item.id"
                    class="hover:bg-gray-50"
                  >
                    <td class="px-4 py-3 text-sm text-gray-900">
                      {{ item.type }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900 font-mono">
                      {{ item.value }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                      {{ item.notes || '-' }}
                    </td>
                    <td class="px-4 py-3 text-sm">
                      <button
                        @click="removeFromAllowList(item.id)"
                        class="text-red-600 hover:text-red-800"
                      >
                        Remove
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Domains Tab -->
        <div v-if="currentTab === 'domains'">
          <div class="bg-white rounded-lg shadow-material p-6">
            <h2 class="text-lg font-semibold mb-4">Domain Statistics</h2>
            <div v-if="domainStats.length === 0" class="text-center py-12">
              <svg
                class="w-16 h-16 mx-auto mb-4 text-primary-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"
                />
              </svg>
              <p class="text-gray-500">No domain statistics yet</p>
              <p class="text-gray-400 text-sm mt-1">
                Statistics will appear as emails are processed
              </p>
            </div>
            <div v-else class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Domain
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Attempts
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Success
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Failed
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Last Attempt
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Status
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <tr
                    v-for="item in domainStats"
                    :key="item.domain"
                    class="hover:bg-gray-50"
                  >
                    <td class="px-4 py-3 text-sm text-gray-900 font-mono">
                      {{ item.domain }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                      {{ item.attemptCount }}
                    </td>
                    <td class="px-4 py-3 text-sm text-green-600">
                      {{ item.successCount }}
                    </td>
                    <td class="px-4 py-3 text-sm text-red-600">
                      {{ item.failedCount }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                      {{ item.lastAttemptAt ? new
                      Date(item.lastAttemptAt).toLocaleDateString() : '-' }}
                    </td>
                    <td class="px-4 py-3 text-sm">
                      <span
                        v-if="item.flaggedIneffective"
                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800"
                        :title="'Emails received after unsubscribe: ' + item.emailsAfterUnsubscribe"
                      >
                        Ineffective
                      </span>
                      <span
                        v-else-if="item.successCount > 0"
                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800"
                      >
                        Compliant
                      </span>
                      <span
                        v-else
                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600"
                      >
                        Pending
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Patterns Tab -->
        <div v-if="currentTab === 'patterns'">
          <div class="bg-white rounded-lg shadow-material p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-semibold">Patterns</h2>
              <div class="space-x-2">
                <button
                  @click="exportPatterns"
                  class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 inline-flex items-center h-10"
                >
                  Export
                </button>
                <label
                  class="bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 cursor-pointer inline-flex items-center h-10"
                >
                  Import
                  <input
                    type="file"
                    @change="importPatterns"
                    accept=".json"
                    class="hidden"
                  />
                </label>
              </div>
            </div>
            <div v-if="patterns.length === 0" class="text-center py-12">
              <svg
                class="w-16 h-16 mx-auto mb-4 text-primary-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"
                />
              </svg>
              <p class="text-gray-500">No patterns configured</p>
              <p class="text-gray-400 text-sm mt-1">
                Import patterns to help identify unsubscribe buttons
              </p>
            </div>
            <div v-else class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Name
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Type
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Selector
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500"
                    >
                      Match Count
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <tr
                    v-for="item in patterns"
                    :key="item.id"
                    class="hover:bg-gray-50"
                  >
                    <td class="px-4 py-3 text-sm text-gray-900">
                      {{ item.name }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                      {{ item.type }}
                    </td>
                    <td
                      class="px-4 py-3 text-sm text-gray-500 font-mono truncate max-w-xs"
                    >
                      {{ item.selector }}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                      {{ item.matchCount }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>

      <!-- Add Allow List Modal -->
      <div
        v-if="showAddModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"
      >
        <div class="bg-white rounded-lg shadow-material-xl p-6 w-full max-w-md">
          <h3 class="text-lg font-semibold mb-4">Add to Allow List</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
              >Type</label>
              <select
                v-model="newEntry.type"
                class="w-full border rounded-md px-3 py-2"
              >
                <option value="email">Email</option>
                <option value="domain">Domain</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
              >Value</label>
              <input
                v-model="newEntry.value"
                type="text"
                class="w-full border rounded-md px-3 py-2"
                :placeholder="newEntry.type === 'email' ? 'user@example.com' : 'example.com'"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
              >Notes (optional)</label>
              <input
                v-model="newEntry.notes"
                type="text"
                class="w-full border rounded-md px-3 py-2"
              />
            </div>
            <div class="flex justify-end space-x-2">
              <button
                @click="showAddModal = false"
                class="px-4 py-2 text-gray-600 hover:text-gray-800"
              >
                Cancel
              </button>
              <button
                @click="addToAllowList"
                class="bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700"
              >
                Add
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Detail Modal -->
      <div
        v-if="selectedItem"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"
      >
        <div
          class="bg-white rounded-lg shadow-material-xl p-6 w-full max-w-3xl max-h-[80vh] overflow-y-auto"
        >
          <h3 class="text-lg font-semibold mb-4">Unsubscribe Details</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <div>
              <span class="font-medium">Sender:</span> {{ selectedItem.sender }}
            </div>
            <div>
              <span class="font-medium">Domain:</span> {{
              selectedItem.senderDomain }}
            </div>
            <div>
              <span class="font-medium">Method:</span> {{ selectedItem.method }}
            </div>
            <div>
              <span class="font-medium">Status:</span>
              <span :class="statusClass(selectedItem.status)"
              >{{ selectedItem.status }}</span>
            </div>
            <div>
              <span class="font-medium">Failure Reason:</span> {{
              selectedItem.failureReason || 'N/A' }}
            </div>
            <div>
              <span class="font-medium">Retries:</span> {{
              selectedItem.retryCount }}
            </div>
          </div>
          <div v-if="selectedItem.failureDetails" class="mb-4">
            <span class="font-medium">Details:</span>
            <pre
              class="bg-gray-100 p-2 rounded mt-1 text-sm whitespace-pre-wrap break-words overflow-x-auto max-w-full"
            >{{ selectedItem.failureDetails }}</pre>
          </div>
          <div v-if="selectedItem.screenshotPath" class="mb-4">
            <span class="font-medium">Screenshot:</span>
            <div class="mt-2 border rounded">
              <img
                :src="'/screenshots/' + selectedItem.id + '.png'"
                alt="Screenshot"
                class="max-w-full"
              />
            </div>
          </div>
          <div class="flex justify-end space-x-2">
            <a
              v-if="selectedItem.tracePath"
              :href="'/api/failed/' + selectedItem.id + '/trace'"
              class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300"
            >
              Download Trace
            </a>
            <button
              @click="selectedItem = null"
              class="px-4 py-2 text-gray-600 hover:text-gray-800"
            >
              Close
            </button>
          </div>
        </div>
      </div>

      <!-- Toast Notifications -->
      <div class="fixed bottom-4 right-4 space-y-2">
        <div
          v-for="toast in toasts"
          :key="toast.id"
          :class="['px-4 py-2 rounded-md shadow-material text-white', toast.type === 'success' ? 'bg-green-600' : 'bg-red-600']"
        >
          {{ toast.message }}
        </div>
      </div>
    </div>

    <script>
      // Get CSRF token from cookie
      function getCsrfToken() {
        const match = document.cookie.match(/csrf=([^;]+)/);
        return match ? match[1] : null;
      }

      // Helper for fetch with CSRF token
      async function fetchWithCsrf(url, options = {}) {
        const csrfToken = getCsrfToken();
        const headers = options.headers || {};
        if (csrfToken && options.method && options.method !== "GET") {
          headers["X-CSRF-Token"] = csrfToken;
        }
        return fetch(url, { ...options, headers });
      }

      const { createApp, ref, onMounted, computed, watch } = Vue;

      createApp({
        setup() {
          const tabs = [
            { id: "dashboard", label: "Dashboard" },
            { id: "failed", label: "Failed" },
            { id: "allowlist", label: "Allow List" },
            { id: "domains", label: "Domains" },
            { id: "patterns", label: "Patterns" },
          ];
          const validTabs = tabs.map((t) => t.id);

          // Initialize from URL hash
          const getTabFromHash = () => {
            const hash = window.location.hash.slice(1);
            return validTabs.includes(hash) ? hash : "dashboard";
          };

          const currentTab = ref(getTabFromHash());

          // Update URL when tab changes
          watch(currentTab, (newTab) => {
            window.location.hash = newTab;
          });

          // Handle browser back/forward
          window.addEventListener("hashchange", () => {
            currentTab.value = getTabFromHash();
          });

          const stats = ref({
            total: 0,
            success: 0,
            failed: 0,
            uncertain: 0,
            pending: 0,
            successRate: 0,
          });
          const recentActivity = ref([]);
          const failedAttempts = ref([]);
          const allowList = ref([]);
          const domainStats = ref([]);
          const patterns = ref([]);
          const selectedItem = ref(null);
          const showAddModal = ref(false);
          const newEntry = ref({ type: "email", value: "", notes: "" });
          const toasts = ref([]);
          const scanInProgress = ref(false);
          const gmailStatus = ref({
            authorized: false,
            connectedEmail: null,
          });

          const showToast = (message, type = "success") => {
            const id = Date.now();
            toasts.value.push({ id, message, type });
            setTimeout(() => {
              toasts.value = toasts.value.filter((t) => t.id !== id);
            }, 3000);
          };

          const fetchStats = async () => {
            try {
              const res = await fetch("/api/stats");
              stats.value = await res.json();
            } catch (e) {
              console.error("Failed to fetch stats:", e);
            }
          };

          const fetchRecent = async () => {
            try {
              const res = await fetch("/api/recent");
              recentActivity.value = await res.json();
            } catch (e) {
              console.error("Failed to fetch recent:", e);
            }
          };

          const fetchFailed = async () => {
            try {
              const res = await fetch("/api/failed");
              failedAttempts.value = await res.json();
            } catch (e) {
              console.error("Failed to fetch failed:", e);
            }
          };

          const fetchAllowList = async () => {
            try {
              const res = await fetch("/api/allowlist");
              allowList.value = await res.json();
            } catch (e) {
              console.error("Failed to fetch allow list:", e);
            }
          };

          const fetchDomains = async () => {
            try {
              const res = await fetch("/api/unsubscribe-logs");
              domainStats.value = await res.json();
            } catch (e) {
              console.error("Failed to fetch domains:", e);
            }
          };

          const fetchPatterns = async () => {
            try {
              const res = await fetch("/api/patterns");
              patterns.value = await res.json();
            } catch (e) {
              console.error("Failed to fetch patterns:", e);
            }
          };

          const fetchScanStatus = async () => {
            try {
              const res = await fetch("/api/scan/status");
              const data = await res.json();
              scanInProgress.value = data.inProgress;
            } catch (e) {
              console.error("Failed to fetch scan status:", e);
            }
          };

          const fetchGmailStatus = async () => {
            try {
              const res = await fetch("/oauth/status");
              gmailStatus.value = await res.json();
            } catch (e) {
              console.error("Failed to fetch Gmail status:", e);
            }
          };

          const connectGmail = () => {
            window.location.href = "/oauth/authorize";
          };

          const disconnectGmail = async () => {
            try {
              await fetchWithCsrf("/oauth/revoke", { method: "POST" });
              showToast("Gmail disconnected");
              await fetchGmailStatus();
            } catch (e) {
              showToast("Failed to disconnect Gmail", "error");
            }
          };

          const triggerScan = async () => {
            try {
              scanInProgress.value = true;
              const res = await fetchWithCsrf("/api/scan", {
                method: "POST",
              });
              if (res.ok) {
                showToast("Scan started");
                // Poll for completion
                const pollInterval = setInterval(async () => {
                  await fetchScanStatus();
                  if (!scanInProgress.value) {
                    clearInterval(pollInterval);
                    showToast("Scan complete");
                    await fetchStats();
                    await fetchRecent();
                  }
                }, 2000);
              } else {
                const data = await res.json();
                showToast(
                  data.error || "Failed to start scan",
                  "error",
                );
                scanInProgress.value = false;
              }
            } catch (e) {
              showToast("Failed to start scan", "error");
              scanInProgress.value = false;
            }
          };

          const statusClass = (status) => {
            const classes = {
              success:
                "px-2 py-1 text-xs rounded-full bg-green-100 text-green-800",
              failed:
                "px-2 py-1 text-xs rounded-full bg-red-100 text-red-800",
              uncertain:
                "px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800",
              pending:
                "px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800",
            };
            return classes[status] || classes.pending;
          };

          const formatTime = (dateStr) => {
            return new Date(dateStr).toLocaleString();
          };

          const viewDetails = (item) => {
            selectedItem.value = item;
          };

          const retryUnsubscribe = async (id) => {
            try {
              await fetchWithCsrf(`/api/failed/${id}/retry`, {
                method: "POST",
              });
              showToast("Retry scheduled");
              await fetchFailed();
            } catch (e) {
              showToast("Failed to schedule retry", "error");
            }
          };

          const markResolved = async (id) => {
            try {
              await fetchWithCsrf(`/api/failed/${id}/resolve`, {
                method: "POST",
              });
              showToast("Marked as resolved");
              await fetchFailed();
              await fetchStats();
            } catch (e) {
              showToast("Failed to mark resolved", "error");
            }
          };

          const addToAllowList = async () => {
            try {
              await fetchWithCsrf("/api/allowlist", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(newEntry.value),
              });
              showToast("Added to allow list");
              showAddModal.value = false;
              newEntry.value = { type: "email", value: "", notes: "" };
              await fetchAllowList();
            } catch (e) {
              showToast("Failed to add entry", "error");
            }
          };

          const removeFromAllowList = async (id) => {
            try {
              await fetchWithCsrf(`/api/allowlist/${id}`, {
                method: "DELETE",
              });
              showToast("Removed from allow list");
              await fetchAllowList();
            } catch (e) {
              showToast("Failed to remove entry", "error");
            }
          };

          const exportPatterns = () => {
            window.location.href = "/api/patterns/export";
          };

          const importPatterns = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                const data = JSON.parse(e.target.result);
                const res = await fetchWithCsrf(
                  "/api/patterns/import",
                  {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                  },
                );
                const result = await res.json();
                showToast(`Imported ${result.imported} patterns`);
                await fetchPatterns();
              } catch (e) {
                showToast("Failed to import patterns", "error");
              }
            };
            reader.readAsText(file);
          };

          onMounted(() => {
            fetchStats();
            fetchRecent();
            fetchFailed();
            fetchAllowList();
            fetchDomains();
            fetchPatterns();
            fetchScanStatus();
            fetchGmailStatus();
          });

          return {
            currentTab,
            tabs,
            stats,
            recentActivity,
            failedAttempts,
            allowList,
            domainStats,
            patterns,
            selectedItem,
            showAddModal,
            newEntry,
            toasts,
            statusClass,
            formatTime,
            viewDetails,
            retryUnsubscribe,
            markResolved,
            addToAllowList,
            removeFromAllowList,
            exportPatterns,
            importPatterns,
            scanInProgress,
            triggerScan,
            gmailStatus,
            connectGmail,
            disconnectGmail,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
