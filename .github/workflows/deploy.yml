name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Northflank
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ vars.REGISTRY_URL }}/${{ vars.IMAGE_NAME }}:${{ github.sha }}
            ${{ vars.REGISTRY_URL }}/${{ vars.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Northflank
        run: |
          # Trigger Northflank deployment via webhook or API
          # Northflank automatically detects new images when configured
          echo "Deployment triggered for image: ${{ vars.REGISTRY_URL }}/${{ vars.IMAGE_NAME }}:${{ github.sha }}"

          # If using Northflank API for deployment:
          # curl -X POST \
          #   -H "Authorization: Bearer ${{ secrets.NORTHFLANK_API_KEY }}" \
          #   -H "Content-Type: application/json" \
          #   "https://api.northflank.com/v1/projects/${{ vars.NORTHFLANK_PROJECT }}/services/${{ vars.NORTHFLANK_SERVICE }}/deployments" \
          #   -d '{"imageTag": "${{ github.sha }}"}'

      - name: Verify Deployment
        run: |
          # Wait for service to be healthy
          echo "Waiting for deployment to complete..."
          sleep 30

          # Check health endpoint
          # curl -f https://${{ vars.APP_DOMAIN }}/api/health || exit 1
          echo "Deployment verification placeholder - configure with actual health check"
